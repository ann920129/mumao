<script>
/* =========================================================
   共用：資料 / 價格表 / 工具函式
   ========================================================= */

  // 基礎房型資料
  const ROOMS = [
    { key:"jazz", name:"爵士房", maxCats:2, total:7 },
    { key:"upgrade", name:"爵士升等房", maxCats:3, total:7 },
    { key:"first", name:"頭等房", maxCats:4, total:5 },
    { key:"little_president", name:"小總統房", maxCats:6, total:1 },
    { key:"president", name:"大總統房", maxCats:7, total:1 },
    { key:"stand", name:"東海標準房", maxCats:2, total:8 }
  ];

  // 計價用表格
  const FIXED_SINGLE = { jazz:{N06:680,N13:650,N30:550,N90:500}, upgrade:{N06:790,N13:750,N30:650,N90:570}, first:{N06:1010,N13:960,N30:820,N90:730}, little_president:{N06:1800,N13:1700,N30:1600,N90:1400}, president:{N06:2300,N13:2150,N30:1850,N90:1650}, stand:{N06:720,N13:680,N30:570,N90:520} };
  const FIXED_MULTI  = { jazz:{N06:860,N13:810,N30:680,N90:620}, upgrade:{N06:990,N13:940,N30:800,N90:720}, first:{N06:1260,N13:1200,N30:1010,N90:910}, little_president:{N06:2250,N13:2100,N30:1800,N90:1600}, president:{N06:2880,N13:2700,N30:2300,N90:2100}, stand:{N06:900,N13:850,N30:710,N90:650} };

  function pricesFor(k){
    const p={jazz:{s:760,m:950},upgrade:{s:880,m:1100},first:{s:1120,m:1400},little_president:{s:2000,m:2500},president:{s:2560,m:3200},stand:{s:800,m:1000}};
    return p[k] ? {single:p[k].s, multi:p[k].m} : {single:0, multi:0};
  }

  //過年日期14~22
  function inCNY(d){
    const v=(d.getMonth()+1)*100+d.getDate();
    return v>=214 && v<=222;
  }

  function getTier(n){
    if(n>=90)return{code:"N90",label:"90晚"};
    if(n>=30)return{code:"N30",label:"30晚"};
    if(n>=13)return{code:"N13",label:"13晚"};
    if(n>=6)return{code:"N06",label:"6晚"};
    return null;
  }


/* =========================================================
   第一頁：計價報價（page-calc）
   ========================================================= */

  let selectedKey="stand", cats=1;

  function recalc(){
    const ciVal=document.getElementById('checkIn').value;
    const coVal=document.getElementById('checkOut').value;
    if(!ciVal||!coVal) return;

    const ci=new Date(ciVal), co=new Date(coVal);
    if(co<=ci){
      document.getElementById('dateQuickInfo').innerText="日期錯誤";
      return;
    }

    // nightsList：每一個「住宿晚」的日期（checkIn 當天到 checkOut 前一天）
    const nightsList=[];
    let cur=new Date(ci);
    while(cur<co){
      nightsList.push(new Date(cur));
      cur.setDate(cur.getDate()+1);
    }

    const nTotalNights=nightsList.length;
    document.getElementById('dateQuickInfo').innerText=`${nTotalNights+1}天${nTotalNights}夜`;

    const isMulti=(cats>=2), base=pricesFor(selectedKey);
    let total=0, detailText="";

    if(selectedKey==="stand"){
      const hDates=nightsList.filter(inCNY);
      const nDates=nightsList.filter(d=>!inCNY(d));

      let hTotal=0, hStr="", hN=hDates.length;

      // ✅ 過年：8晚套裝 + 超過晚數加購（過年晚數永遠照過年價，不吃長住）
      if(hN>=8){
        const ex=hN-8;
        hTotal=9888 + ex*1250;
        hStr="過年8夜套裝 9888元" + (ex>0?`+加購${ex}晚`:"");
      }else if(hN>=4){
        const ex=hN-4;
        hTotal=6888 + ex*1250;
        hStr=`過年4晚 6888元` + (ex>0?`+加購${ex}晚`:"");
      }else if(hN>0){
        hTotal=hN*1250;
        hStr=`過年單晚${hN}晚`;
      }

      // ✅ 非過年：可以合計「整筆總晚數」決定 tier（N13/N30...），但只套用在非過年晚數
      let nTotal=0, nStr="";
      if(nDates.length>0){
        const tier = getTier(nTotalNights); // ★關鍵：用總晚數決定長住級距
        let up = isMulti ? base.multi : base.single;

        const tbl = isMulti ? FIXED_MULTI.stand : FIXED_SINGLE.stand;
        if(tier && tbl[tier.code]) up = tbl[tier.code];

        nTotal = nDates.length * up;
        nStr = `非過年${nDates.length}晚(${tier ? tier.label : '一般'} 單價${up}元)`;
      }

      total=hTotal+nTotal;
      detailText=[hStr,nStr].filter(Boolean).join("+")+"="+total+"元";
    }else{
      // 其他房型：照一般長住算法（未拆過年）
      const tier=getTier(nTotalNights);
      let up=isMulti?base.multi:base.single;
      if(tier){
        const tbl=isMulti?FIXED_MULTI[selectedKey]:FIXED_SINGLE[selectedKey];
        if(tbl[tier.code]) up=tbl[tier.code];
      }
      total=nTotalNights*up;
      detailText=`${up}元*${nTotalNights}晚=${total}元`;
    }

    document.getElementById('resPriceDetail').innerText=detailText;

    const dep=Math.round(total*0.3);
    const bal=total-dep;
    document.getElementById('resDeposit').innerText=`NT$ ${dep}`;
    document.getElementById('resBalance').innerText=`NT$ ${bal}`;
    document.getElementById('resTotal').innerText=`NT$ ${total}`;

    const d1=(ci.getMonth()+1)+"/"+ci.getDate();
    const d2=(co.getMonth()+1)+"/"+co.getDate();
    document.getElementById('copyText').innerText=`${d1}~${d2} 共${nTotalNights}晚\n費用${total}元\n訂金${dep}元\n尾款${bal}元`;
  }

  function renderRoomRadios(){
    const l=document.getElementById('roomList');
    l.innerHTML='';
    ROOMS.forEach(r=>{
      const d=document.createElement('label');
      d.className='radio';
      d.innerHTML=`<input type="radio" name="room" ${selectedKey===r.key?'checked':''}>${r.name}`;
      d.onclick=()=>{selectedKey=r.key; recalc();};
      l.appendChild(d);
    });
  }


/* =========================================================
   第二頁：房號月曆管理（page-calendar）
   ========================================================= */

  let curCalDate = new Date();
  let orders = JSON.parse(localStorage.getItem('catHotel_orders') || '[]');

  function changeMonth(step){
    curCalDate.setMonth(curCalDate.getMonth()+step);
    renderCalendar();
  }

  function updateRoomNoOptions(){
    const tk=document.getElementById('addType').value;
    const r=ROOMS.find(x=>x.key===tk);
    const s=document.getElementById('addRoomNo');
    s.innerHTML='';
    for(let i=1;i<=r.total;i++){
      s.innerHTML+=`<option value="${i}">${i}號房</option>`;
    }
  }

  function addOrder(){
    const type=document.getElementById('addType').value;
    const no=document.getElementById('addRoomNo').value;
    const start=document.getElementById('addIn').value;
    const end=document.getElementById('addOut').value;

    if(!start||!end||start>end) return alert("日期錯誤！");

    orders.push({ id:Date.now(), type, no, start, end });
    localStorage.setItem('catHotel_orders', JSON.stringify(orders));

    renderCalendar();
    renderOrderList();
  }

  function deleteOrder(id){
    orders=orders.filter(o=>o.id!==id);
    localStorage.setItem('catHotel_orders', JSON.stringify(orders));
    renderCalendar();
    renderOrderList();
  }

  function renderOrderList(){
    const container=document.getElementById('orderList');
    container.innerHTML=orders.map(o=>{
      const rn=ROOMS.find(r=>r.key===o.type).name;
      return `<div class="order-item">
        <div><strong>${rn}-${o.no}號房</strong><br><small>${o.start} ~ ${o.end}</small></div>
        <button class="del-btn" onclick="deleteOrder(${o.id})">×</button>
      </div>`;
    }).join('');
  }

  function renderCalendar(){
    const year=curCalDate.getFullYear(), month=curCalDate.getMonth();
    document.getElementById('curMonthText').innerText=`${year} 年 ${String(month+1).padStart(2,'0')} 月`;

    const firstDay=new Date(year, month, 1).getDay();
    const daysInMonth=new Date(year, month+1, 0).getDate();
    const calBody=document.getElementById('calBody');
    const viewType=document.getElementById('viewRoomType').value;

    calBody.innerHTML='';
    let dateNum=1;

    for(let i=0;i<6;i++){
      const tr=document.createElement('tr');

      for(let j=0;j<7;j++){
        const td=document.createElement('td');

        if((i===0 && j<firstDay) || dateNum>daysInMonth){
          // 空白格
        }else{
          const dStr=`${year}-${String(month+1).padStart(2,'0')}-${String(dateNum).padStart(2,'0')}`;

          let html=`<span class="date-num">${dateNum}</span><div class="room-status">`;

          ROOMS.forEach(room=>{
            if(viewType!=='ALL' && viewType!==room.key) return;

            // 入/退宿當日皆扣房：start<=d<=end
            const occupied=orders.filter(o=>o.type===room.key && dStr>=o.start && dStr<=o.end).length;
            const left=room.total-occupied;

            html+=`<div class="status-item">
              <span>${room.name.slice(0,2)}</span>
              <span class="${left<=0?'full':''}">${left<=0?'滿':left}</span>
            </div>`;
          });

          td.innerHTML=html+`</div>`;
          dateNum++;
        }

        tr.appendChild(td);
      }

      calBody.appendChild(tr);
      if(dateNum>daysInMonth) break;
    }
  }


/* =========================================================
   分頁切換 + 初始化
   ========================================================= */

  // Tab 切換
  document.getElementById('tab-calc').onclick=function(){
    this.classList.add('active');
    document.getElementById('tab-calendar').classList.remove('active');
    document.getElementById('page-calc').style.display='block';
    document.getElementById('page-calendar').style.display='none';
  };

  document.getElementById('tab-calendar').onclick=function(){
    this.classList.add('active');
    document.getElementById('tab-calc').classList.remove('active');
    document.getElementById('page-calc').style.display='none';
    document.getElementById('page-calendar').style.display='block';

    renderCalendar();
    updateRoomNoOptions();
    renderOrderList();
  };

  // Calc頁控制
  document.getElementById('minusCats').onclick=()=>{
    if(cats>1){
      cats--;
      document.getElementById('catsText').innerText=`${cats} 隻`;
      recalc();
    }
  };

  document.getElementById('plusCats').onclick=()=>{
    if(cats<ROOMS.find(r=>r.key===selectedKey).maxCats){
      cats++;
      document.getElementById('catsText').innerText=`${cats} 隻`;
      recalc();
    }
  };

  document.getElementById('checkIn').onchange=recalc;
  document.getElementById('checkOut').onchange=recalc;

  // 初始化
  renderRoomRadios();
  recalc();
</script>

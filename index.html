<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>訂房計價 Demo（長住方案 + 一般方案）</title>
  <style>
    /* ===== Morandi 調色 ===== */
    :root{
      --bg:#f2efe9;           /* 背景：暖灰米色 */
      --card:#ffffff;         /* 卡片：象牙白 */
      --text:#3f3a3a;         /* 文字：深咖啡灰 */
      --muted:#7d7671;        /* 次要文字：灰褐 */
      --accent:#6b8e7a;       /* 重點：鼠尾草綠 */
      --accent-strong:#4f7a66;
      --btn:#e7e3dd;          /* 按鈕底色：淺米灰 */
      --btn2:#d6d1ca;         /* 次要按鈕 */
      --danger:#b76e79;       /* 警示：玫瑰褐 */

      --input-bg:#f6f3ee;
      --input-border:#d5cfc8;
      --shadow:0 8px 18px rgba(0,0,0,.06);
    }
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Arial;
    }
    .container{max-width:920px;margin:0 auto;padding:22px;}
    h1{font-size:22px;margin:0 0 16px;font-weight:800;color:#3a3734}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{
      background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow);
      border:1px solid #eee7df;
    }
    .label{font-size:14px;color:var(--muted);margin-bottom:6px}
    .title{font-weight:700}
    .hint{color:var(--muted);font-size:14px}
    .accent{color:var(--accent-strong);font-weight:700}
    .money{font-weight:800}

    input,select,button{font-size:16px}
    input[type="date"], select{
      background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);border-radius:10px;
      padding:8px 10px;min-width:160px;outline:none;
    }
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--input-border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{background:var(--btn2);border:1px solid var(--input-border)}
    .pill{
      display:inline-block;background:var(--input-bg);border:1px solid var(--input-border);border-radius:999px;padding:6px 10px;font-size:14px
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
    .right{text-align:right}

    .radio{
      display:flex;gap:12px;align-items:center;border:1px solid var(--input-border);
      background:var(--input-bg);border-radius:12px;padding:10px 12px;cursor:pointer
    }
    .radio input{accent-color:var(--accent);transform:scale(1.1)}
    .flex-between{display:flex;justify-content:space-between;align-items:center}

    /* 摘要底部 3 欄（訂金 / 尾款 / 總價） */
    .summary-bottom{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed var(--input-border);
    }
    .summary-box{
      background:var(--input-bg);
      border:1px solid var(--input-border);
      border-radius:12px;
      padding:12px;
      text-align:center;
    }
    .summary-box .label{ color:var(--muted); font-size:14px; margin-bottom:4px; }
    .summary-box .value{ font-weight:800; font-size:18px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>訂房計價 Demo（長住方案 + 一般方案）</h1>

    <!-- 日期 -->
    <div class="card">
      <div class="row">
        <div>
          <div class="label">入住日（check-in）</div>
          <input id="checkIn" type="date">
        </div>
        <div>
          <div class="label">退房日（check-out，當天不入住）</div>
          <input id="checkOut" type="date">
        </div>
        <div style="align-self:end">
          <button id="btnTodayToTomorrow" class="btn">今天→明天</button>
        </div>
      </div>
      <div id="dateInfo" class="hint" style="margin-top:10px"></div>
    </div>

    <!-- 房型單選 -->
    <div class="card">
      <div class="label">選擇房型（擇一）</div>
      <div id="roomList" class="grid"></div>
    </div>

    <!-- 入住貓咪數（放在摘要前面） -->
    <div class="card" id="catsCard">
      <div class="flex-between">
        <div>
          <div class="title">入住貓咪數</div>
          <div id="catsHint" class="hint">請先選房型</div>
        </div>
        <div>
          <button id="minusCats" class="btn2">－</button>
          <span id="catsText" class="pill" style="margin:0 8px">1 隻</span>
          <button id="plusCats" class="btn">＋</button>
        </div>
      </div>
    </div>

    <!-- 預訂摘要（最下方，含三欄） -->
    <div class="card">
      <div class="title" style="margin-bottom:8px">預訂摘要</div>
      <div id="summary"></div>
    </div>
  </div>

  <script>
    // ------------------ 設定：房型、一般價、長住固定價 ------------------
    const ROOMS = [
      { key:"jazz", name:"爵士房", base:760,  maxCats:2 },
      { key:"upgrade", name:"爵士升等房", base:1100, maxCats:3 },
      { key:"first", name:"頭等房", base:1400, maxCats:4 },
      { key:"little_president", name:"小總統房", base:2500, maxCats:6 },
      { key:"president", name:"大總統房", base:3200, maxCats:7 },
    ];

    // 一般方案：單貓/多貓一口價
    function pricesFor(key){
      switch(key){
        case "jazz":              return { single:760,  multi:950 };
        case "upgrade":           return { single:880,  multi:1100 };
        case "first":             return { single:1120, multi:1400 };
        case "little_president":  return { single:2000, multi:2500 };
        case "president":         return { single:2560, multi:3200 };
        default:                  return { single:0,    multi:0 };
      }
    }

    // 長住 tier
    const Tier = { N90:90, N30:30, N13:13, N06:6 };
    function currentTier(nights){
      if (nights >= Tier.N90) return {code:"N90", label:"90 晚起"};
      if (nights >= Tier.N30) return {code:"N30", label:"30 晚起"};
      if (nights >= Tier.N13) return {code:"N13", label:"13 晚起"};
      if (nights >= Tier.N06) return {code:"N06", label:"6 晚起"};
      return null;
    }

    // 長住固定單價（單貓）
    const FIXED_SINGLE = {
      jazz: { N06:680,  N13:650,  N30:550,  N90:500 },
      upgrade: { N06:790, N13:750, N30:650, N90:570 },
      first: { N06:1010, N13:960, N30:820, N90:730 },
      little_president: { N06:1800, N13:1700, N30:1600, N90:1400 }, // ← 修正：與 App 一致
      president: { N06:2300, N13:2150, N30:1850, N90:1650 }
    };
    // 長住固定單價（多貓：兩隻以上）
    const FIXED_MULTI = {
      jazz: { N06:860,  N13:810,  N30:680,  N90:620 },
      upgrade: { N06:990, N13:940, N30:800, N90:720 },
      first: { N06:1260, N13:1200, N30:1010, N90:910 },
      little_president: { N06:2250, N13:2100, N30:1800, N90:1600 },
      president: { N06:2880, N13:2700, N30:2300, N90:2100 }
    };

    // 四捨五入 30% 訂金
    function calcDeposit(total){
      if (total <= 0) return 0;
      return Math.floor((total * 3 + 5) / 10);
    }

    // ------------------ 狀態 ------------------
    const elCheckIn  = document.getElementById('checkIn');
    const elCheckOut = document.getElementById('checkOut');
    const elBtnToday = document.getElementById('btnTodayToTomorrow');
    const elDateInfo = document.getElementById('dateInfo');
    const elRoomList = document.getElementById('roomList');
    const elCatsHint = document.getElementById('catsHint');
    const elMinusCats= document.getElementById('minusCats');
    const elPlusCats = document.getElementById('plusCats');
    const elCatsText = document.getElementById('catsText');
    const elSummary  = document.getElementById('summary');

    let selectedKey = null;
    let cats = 1;

    // init 日期：今天→明天
    (function initDates(){
      const today = new Date();
      const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1);
      elCheckIn.value  = fmtDate(today);
      elCheckOut.value = fmtDate(tomorrow);
    })();

    function fmtDate(d){
      const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
      return `${y}-${m}-${dd}`;
    }
    function parseDate(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }

    function getNights(){
      const ci = parseDate(elCheckIn.value);
      const co = parseDate(elCheckOut.value);
      const ms = co - ci;
      const nights = Math.max(0, Math.round(ms / (1000*60*60*24)));
      return nights;
    }

    function clampCats(){
      const room = ROOMS.find(r=>r.key===selectedKey);
      const maxCats = room ? room.maxCats : 1;
      cats = Math.min(Math.max(1, cats), maxCats);
      elCatsText.textContent = `${cats} 隻`;
      elMinusCats.disabled = (cats<=1);
      elPlusCats.disabled  = !room || (cats>=maxCats);
      elCatsHint.textContent = room
        ? `兩隻以上一律多貓價；本房型最多 ${maxCats} 隻`
        : '請先選房型';
    }

    // 建立房型單選
    function renderRooms(){
      elRoomList.innerHTML = '';
      ROOMS.forEach(room=>{
        const p = pricesFor(room.key);
        const id = `room_${room.key}`;
        const div = document.createElement('label');
        div.className = 'radio';
        div.innerHTML = `
          <input type="radio" name="room" id="${id}">
          <div>
            <div class="title">${room.name}</div>
            <div class="hint">一般單晚（單貓／多貓）：NT$ ${p.single}／${p.multi}（上限 ${room.maxCats} 隻）</div>
          </div>
        `;
        div.querySelector('input').checked = (selectedKey === room.key);
        div.addEventListener('change', ()=>{
          selectedKey = room.key;
          clampCats();
          recalc();
        });
        elRoomList.appendChild(div);
      });
    }

    function nightlyPriceWithTag(roomKey, cats, nights){
      const tier = currentTier(nights);
      if (tier){
        const table = (cats >= 2) ? FIXED_MULTI : FIXED_SINGLE;
        const price = table?.[roomKey]?.[tier.code] ?? 0;
        return { nightly: price, tag: `已套用長住方案：${tier.label}` };
      }else{
        const p = pricesFor(roomKey);
        return { nightly: (cats>=2) ? p.multi : p.single, tag: '方案：一般方案' };
      }
    }

    function recalc(){
      // 日期資訊
      const ci = elCheckIn.value, co = elCheckOut.value;
      const nights = getNights();
      const days = nights + 1;
      elDateInfo.textContent = `入住：${ci}　退房：${co}　→ 共 ${days} 天 ${nights} 夜（夜數計價）`;

      const room = ROOMS.find(r=>r.key===selectedKey);
      const roomPrices = room ? pricesFor(room.key) : null;

      let pricePerNight = 0, priceTag = null;
      if (room){
        const res = nightlyPriceWithTag(room.key, cats, nights);
        pricePerNight = res.nightly;
        priceTag = res.tag;
      }
      const total = (pricePerNight>0 && nights>0) ? pricePerNight * nights : 0;
      const deposit = calcDeposit(total);
      const balance = Math.max(0, total - deposit);

      // 摘要（含底部三欄）
      elSummary.innerHTML = `
        <div class="grid">
          <div>
            <div class="label">房型</div>
            <div>${room ? room.name : '尚未選擇'}</div>
          </div>
          <div>
            <div class="label">一般單晚（單貓／多貓）</div>
            <div>${roomPrices ? `NT$ ${roomPrices.single}／${roomPrices.multi}` : '—'}</div>
          </div>
          <div>
            <div class="label">貓咪</div>
            <div>${cats} 隻（兩隻以上用多貓價）</div>
          </div>
          <div>
            <div class="label">夜數</div>
            <div>${nights} 夜</div>
          </div>
          <div>
            <div class="label">計價單晚</div>
            <div class="accent">NT$ ${pricePerNight || 0} ${priceTag?`<span class="hint"> ${priceTag}</span>`:''}</div>
          </div>
        </div>

        <div class="summary-bottom">
          <div class="summary-box">
            <div class="label">訂金 30%（四捨五入）</div>
            <div class="value">NT$ ${deposit}</div>
          </div>
          <div class="summary-box">
            <div class="label">尾款</div>
            <div class="value">NT$ ${balance}</div>
          </div>
          <div class="summary-box">
            <div class="label">總價</div>
            <div class="value">NT$ ${total}</div>
          </div>
        </div>
      `;
    }

    // 事件
    elCheckIn.addEventListener('change', ()=>{
      // 至少 1 夜
      const ci = parseDate(elCheckIn.value);
      const co = parseDate(elCheckOut.value);
      if (co <= ci){
        const t = new Date(ci); t.setDate(ci.getDate()+1);
        elCheckOut.value = fmtDate(t);
      }
      recalc();
    });
    elCheckOut.addEventListener('change', ()=>{
      const ci = parseDate(elCheckIn.value);
      const co = parseDate(elCheckOut.value);
      if (co <= ci){
        const t = new Date(ci); t.setDate(ci.getDate()+1);
        elCheckOut.value = fmtDate(t);
      }
      recalc();
    });
    elBtnToday.addEventListener('click', ()=>{
      const today = new Date(), tom = new Date(); tom.setDate(today.getDate()+1);
      elCheckIn.value = fmtDate(today); elCheckOut.value = fmtDate(tom);
      recalc();
    });
    elMinusCats.addEventListener('click', ()=>{ cats=Math.max(1,cats-1); clampCats(); recalc(); });
    elPlusCats.addEventListener('click',  ()=>{ cats+=1; clampCats(); recalc(); });

    // 初始
    renderRooms();
    clampCats();
    recalc();
  </script>
</body>
</html>

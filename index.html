<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>訂房計價 Demo（長住方案 + 一般方案 / 東海店過年限定）</title>
  <style>
    /* ===== Morandi 調色 ===== */
    :root{
      --bg:#f2efe9; --card:#ffffff; --text:#3f3a3a; --muted:#7d7671;
      --accent:#6b8e7a; --accent-strong:#4f7a66; --btn:#e7e3dd; --btn2:#d6d1ca; --danger:#b76e79;
      --input-bg:#f6f3ee; --input-border:#d5cfc8; --shadow:0 8px 18px rgba(0,0,0,.06);
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}
    .container{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 16px;font-weight:800;color:#3a3734}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--input-border);background:var(--card);cursor:pointer}
    .tab.active{background:var(--accent);color:#fff;border-color:transparent}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid #eee7df}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .title{font-weight:700}
    .hint{color:var(--muted);font-size:13px}
    .accent{color:var(--accent-strong);font-weight:700}
    .money{font-weight:800}
    input,select,button{font-size:16px}
    input[type="date"],select{background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);border-radius:10px;padding:8px 10px;min-width:150px;outline:none}
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--input-border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{filter:brightness(.98)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{background:var(--btn2);border:1px solid var(--input-border)}
    .pill{display:inline-block;background:var(--input-bg);border:1px solid var(--input-border);border-radius:999px;padding:6px 10px;font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .right{text-align:right}
    .radio{display:flex;gap:12px;align-items:center;border:1px solid var(--input-border);background:var(--input-bg);border-radius:12px;padding:10px 12px;cursor:pointer}
    .radio input{accent-color:var(--accent);transform:scale(1.1)}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .summary-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;padding-top:12px;border-top:1px dashed var(--input-border)}
    .summary-box{background:var(--input-bg);border:1px solid var(--input-border);border-radius:12px;padding:12px;text-align:center}
    .summary-box .label{color:var(--muted);font-size:14px;margin-bottom:4px}
    .summary-box .value{font-weight:800;font-size:18px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:860px){.two-col{grid-template-columns:1fr}h1{font-size:18px}.label,.hint{font-size:12px}}
    .calendar{background:var(--card);border:1px solid var(--input-border);border-radius:12px;padding:10px;box-shadow:var(--shadow);min-height:520px}
    .calendar .month-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .calendar table{border-collapse:collapse;width:100%}
    .calendar th,.calendar td{border:1px solid var(--input-border);padding:6px;text-align:center}
    .calendar td .left{font-size:12px;color:var(--muted)}
    .calendar .soldout{color:var(--danger);font-weight:700}
    .calendar .ok{color:var(--accent-strong);font-weight:700}
    .calendar-summary{background:var(--card);border:1px solid var(--input-border);border-radius:12px;padding:12px;box-shadow:var(--shadow);min-height:520px;display:flex;flex-direction:column;justify-content:space-between}
  </style>
</head>
<body>
  <div class="container">
    <h1>訂房計價 Demo（長住 + 一般 / 東海店過年限定）</h1>

    <div class="tabs">
      <button class="tab active" id="tabCalc">計價頁</button>
      <button class="tab" id="tabCalendar">空房月曆</button>
    </div>

    <!-- Page 1 -->
    <div id="pageCalc">
      <div class="card">
        <div class="row">
          <div>
            <div class="label">入住日（check-in）</div>
            <input id="checkIn" type="date">
          </div>
          <div>
            <div class="label">退房日（check-out，當天不入住）</div>
            <input id="checkOut" type="date">
          </div>
          <div style="align-self:end">
            <button id="btnTodayToTomorrow" class="btn">今天→明天</button>
          </div>
        </div>
        <div id="dateInfo" class="hint" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <div class="label">選擇房型（擇一）</div>
        <div id="roomList" class="grid"></div>
      </div>

      <div class="card" id="catsCard">
        <div class="flex-between">
          <div>
            <div class="title">入住貓咪數</div>
            <div id="catsHint" class="hint">請先選房型</div>
          </div>
          <div>
            <button id="minusCats" class="btn2">－</button>
            <span id="catsText" class="pill" style="margin:0 8px">1 隻</span>
            <button id="plusCats" class="btn">＋</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="title" style="margin-bottom:8px">預訂摘要</div>
        <div id="summary"></div>
      </div>
    </div>

    <!-- Page 2 -->
    <div id="pageCalendar" style="display:none">
      <div class="two-col">
        <div class="calendar">
          <div class="month-bar">
            <button id="prevMonth" class="btn2">‹ 上一月</button>
            <div id="monthTitle" class="title"></div>
            <button id="nextMonth" class="btn">下一月 ›</button>
          </div>
          <table id="calTable">
            <thead>
              <tr><th>日</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="calendar-summary" id="calendarSummary">
          <div>
            <div class="title" style="margin-bottom:8px">本月空房摘要（8 間上限）</div>
            <div class="hint" id="legendHint">（示意）點選日曆可標記已訂數量。</div>
            <div id="monthStats" style="margin-top:10px"></div>
          </div>
          <div class="hint">* 前端示意：預設每日最多 8 間，點日格循環設定已訂數量。正式上線請串接後端。</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ------------------ 房型/價格/長住/過年 ------------------ */
    const ROOMS = [
      { key:"jazz", name:"爵士房", base:760,  maxCats:2 },
      { key:"upgrade", name:"爵士升等房", base:1100, maxCats:3 },
      { key:"first", name:"頭等房", base:1400, maxCats:4 },
      { key:"little_president", name:"小總統房", base:2500, maxCats:6 },
      { key:"president", name:"大總統房", base:3200, maxCats:7 },
      { key:"stand", name:"東海標準房", base:800,  maxCats:2 }
    ];

    // 一般方案：單貓/多貓一口價
    function pricesFor(key){
      switch(key){
        case "jazz":              return { single:760,  multi:950 };
        case "upgrade":           return { single:880,  multi:1100 };
        case "first":             return { single:1120, multi:1400 };
        case "little_president":  return { single:2000, multi:2500 };
        case "president":         return { single:2560, multi:3200 };
        case "stand":             return { single:800,  multi:1000 };
        default:                  return { single:0,    multi:0 };
      }
    }

    // 長住門檻（只計「非過年晚數」）
    const Tier = { N90:90, N30:30, N13:13, N06:6 };
    function currentTier(nonHolidayN){
      if (nonHolidayN >= Tier.N90) return {code:"N90", label:"90 晚起"};
      if (nonHolidayN >= Tier.N30) return {code:"N30", label:"30 晚起"};
      if (nonHolidayN >= Tier.N13) return {code:"N13", label:"13 晚起"};
      if (nonHolidayN >= Tier.N06) return {code:"N06", label:"6 晚起"};
      return null;
    }

    // 長住固定單價（單貓）
    const FIXED_SINGLE = {
      jazz: { N06:680,  N13:650,  N30:550,  N90:500 },
      upgrade: { N06:790, N13:750, N30:650, N90:570 },
      first: { N06:1010, N13:960, N30:820, N90:730 },
      little_president: { N06:1800, N13:1700, N30:1600, N90:1400 },
      president: { N06:2300, N13:2150, N30:1850, N90:1650 },
      /* ★CHANGED: stand 也吃長住（單貓） */
      stand: { N06:720, N13:680, N30:570, N90:520 }
    };
    // 長住固定單價（多貓）
    const FIXED_MULTI = {
      jazz: { N06:860,  N13:810,  N30:680,  N90:620 },
      upgrade: { N06:990, N13:940, N30:800, N90:720 },
      first: { N06:1260, N13:1200, N30:1010, N90:910 },
      little_president: { N06:2250, N13:2100, N30:1800, N90:1600 },
      president: { N06:2880, N13:2700, N30:2300, N90:2100 },
      /* ★CHANGED: stand 也吃長住（多貓） */
      stand: { N06:900, N13:850, N30:710, N90:650 }
    };

    /* ===== 東海過年（只適用 stand） ===== */
    const CNY_START = { m:2, d:14 };
    const CNY_END   = { m:2, d:22 };
    function inCNY(dateObj){
      const m = dateObj.getMonth()+1, d = dateObj.getDate();
      return (m> CNY_START.m || (m===CNY_START.m && d>=CNY_START.d)) &&
             (m< CNY_END.m   || (m===CNY_END.m   && d<=CNY_END.d));
    }

    function enumerateNights(ci, co){
      const list = []; let cur = new Date(ci);
      while(cur < co){ list.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return list;
    }

    // 訂金 30%（四捨五入）
    function calcDeposit(total){ return total<=0 ? 0 : Math.floor((total*3+5)/10); }

    /* ------------------ 計價狀態 ------------------ */
    const elCheckIn  = document.getElementById('checkIn');
    const elCheckOut = document.getElementById('checkOut');
    const elBtnToday = document.getElementById('btnTodayToTomorrow');
    const elDateInfo = document.getElementById('dateInfo');
    const elRoomList = document.getElementById('roomList');
    const elCatsHint = document.getElementById('catsHint');
    const elMinusCats= document.getElementById('minusCats');
    const elPlusCats = document.getElementById('plusCats');
    const elCatsText = document.getElementById('catsText');
    const elSummary  = document.getElementById('summary');

    let selectedKey = null;
    let cats = 1;

    (function initDates(){
      const today = new Date();
      const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate()+1);
      elCheckIn.value  = fmtDate(today);
      elCheckOut.value = fmtDate(tomorrow);
    })();

    function fmtDate(d){
      const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
      return `${y}-${m}-${dd}`;
    }
    function parseDate(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d); }
    function getNights(){
      const ci=parseDate(elCheckIn.value), co=parseDate(elCheckOut.value);
      return Math.max(0, Math.round((co-ci)/(1000*60*60*24)));
    }

    function clampCats(){
      const room = ROOMS.find(r=>r.key===selectedKey);
      const maxCats = room ? room.maxCats : 1;
      cats = Math.min(Math.max(1, cats), maxCats);
      elCatsText.textContent = `${cats} 隻`;
      elMinusCats.disabled = (cats<=1);
      elPlusCats.disabled  = !room || (cats>=maxCats);
      elCatsHint.textContent = room ? `兩隻以上一律多貓價；本房型最多 ${maxCats} 隻` : '請先選房型';
    }

    function renderRooms(){
      elRoomList.innerHTML = '';
      ROOMS.forEach(room=>{
        const p = pricesFor(room.key);
        const id = `room_${room.key}`;
        const div = document.createElement('label');
        div.className = 'radio';
        div.innerHTML = `
          <input type="radio" name="room" id="${id}">
          <div>
            <div class="title">${room.name}</div>
            <div class="hint">一般單晚（單貓／多貓）：NT$ ${p.single}／${p.multi}（上限 ${room.maxCats} 隻）</div>
          </div>
        `;
        div.querySelector('input').checked = (selectedKey === room.key);
        div.addEventListener('change', ()=>{ selectedKey = room.key; clampCats(); recalc(); });
        elRoomList.appendChild(div);
      });
    }

    // ★CHANGED：stand 混合/非過年也可吃長住；CNY 全段依套裝或 1250/晚
    function computePrice(ciStr, coStr, roomKey, cats){
      if (!roomKey) return { nights:0, nightly:0, priceTag:'', total:0 };
      const ci = parseDate(ciStr), co = parseDate(coStr);
      if (co <= ci) return { nights:0, nightly:0, priceTag:'', total:0 };

      const nightsList = enumerateNights(ci, co);
      const nights = nightsList.length;

      if (roomKey === "stand"){
        const allCNY = nightsList.every(inCNY);
        if (allCNY){
          if (nights === 4) return { nights, nightly: Math.round(6888/4), priceTag:"東海過年 5天4夜套裝", total:6888 };
          if (nights === 8) return { nights, nightly: Math.round(9888/8), priceTag:"東海過年 9天8夜套裝", total:9888 };
          return { nights, nightly:1250, priceTag:"東海過年單晚 1250（單/多同價）", total:1250*nights };
        }
        // 混合或完全非過年：非過年晚可吃長住（用非過年晚數算門檻），過年晚 1250/晚
        const nonHolidayDates = nightsList.filter(d=>!inCNY(d));
        const holidayDates    = nightsList.filter(inCNY);
        const nonHolidayN     = nonHolidayDates.length;

        const tier = currentTier(nonHolidayN);
        let nightlyNonHoliday;
        if (tier){
          nightlyNonHoliday = (cats>=2 ? FIXED_MULTI.stand[tier.code] : FIXED_SINGLE.stand[tier.code]);
        }else{
          const base = pricesFor("stand");
          nightlyNonHoliday = (cats>=2 ? base.multi : base.single);
        }

        const total = nonHolidayN * nightlyNonHoliday + holidayDates.length * 1250;
        const showNightly = nonHolidayN>0 ? nightlyNonHoliday : 1250;
        const tag = (nonHolidayN>0 && tier)
          ? `東海非過年套用長住：${tier.label}（過年夜 1250）`
          : `東海一般/過年混合（非過年${nonHolidayN>0?'一般或長住':''} + 過年 1250）`;
        return { nights, nightly: showNightly, priceTag: tag, total };
      }

      // 其他房型：不吃過年價；非過年可吃長住，過年夜用一般 nightly
      const p = pricesFor(roomKey);
      const nonHolidayN = nightsList.filter(d=>!inCNY(d)).length;
      const holidayN    = nights - nonHolidayN;

      let nightlyNonHoliday = (cats>=2 ? p.multi : p.single);
      const tier = currentTier(nonHolidayN);
      if (tier){
        if (cats>=2 && FIXED_MULTI[roomKey]) nightlyNonHoliday = FIXED_MULTI[roomKey][tier.code];
        if (cats<2  && FIXED_SINGLE[roomKey]) nightlyNonHoliday = FIXED_SINGLE[roomKey][tier.code];
      }
      const total = nonHolidayN * nightlyNonHoliday + holidayN * (cats>=2 ? p.multi : p.single);
      const tag = tier ? `非過年套用長住：${tier.label}` : "一般方案（過年夜不享長住）";
      const showNightly = nonHolidayN>0 ? nightlyNonHoliday : (cats>=2?p.multi:p.single);
      return { nights, nightly: showNightly, priceTag: tag, total };
    }

    function recalc(){
      const ci = elCheckIn.value, co = elCheckOut.value;
      const nights = getNights();
      const days = nights + 1;
      elDateInfo.textContent = `入住：${ci}　退房：${co}　→ 共 ${days} 天 ${nights} 夜（長住門檻僅計非過年晚數）`;

      const room = ROOMS.find(r=>r.key===selectedKey);
      const roomPrices = room ? pricesFor(room.key) : null;

      const res = computePrice(ci, co, selectedKey, cats);
      const total = res.total || 0;
      const deposit = calcDeposit(total);
      const balance = Math.max(0, total - deposit);

      elSummary.innerHTML = `
        <div class="grid">
          <div><div class="label">房型</div><div>${room ? room.name : '尚未選擇'}</div></div>
          <div><div class="label">一般單晚（單貓／多貓）</div><div>${roomPrices ? `NT$ ${roomPrices.single}／${roomPrices.multi}` : '—'}</div></div>
          <div><div class="label">貓咪</div><div>${cats} 隻（兩隻以上用多貓價）</div></div>
          <div><div class="label">夜數</div><div>${res.nights} 夜</div></div>
          <div><div class="label">計價單晚</div><div class="accent">NT$ ${res.nightly || 0} ${res.priceTag?`<span class="hint"> ${res.priceTag}</span>`:''}</div></div>
        </div>
        <div class="summary-bottom">
          <div class="summary-box"><div class="label">訂金 30%（四捨五入）</div><div class="value">NT$ ${deposit}</div></div>
          <div class="summary-box"><div class="label">尾款</div><div class="value">NT$ ${balance}</div></div>
          <div class="summary-box"><div class="label">總價</div><div class="value">NT$ ${total}</div></div>
        </div>
      `;
    }

    // 事件
    function ensureAtLeastOneNight(changedEnd){
      const ci = parseDate(elCheckIn.value), co = parseDate(elCheckOut.value);
      if (co <= ci){
        if (changedEnd){
          const t = new Date(ci); t.setDate(ci.getDate()+1); elCheckOut.value = fmtDate(t);
        }else{
          const t = new Date(co); t.setDate(co.getDate()-1); elCheckIn.value = fmtDate(t);
        }
      }
    }
    elCheckIn.addEventListener('change', ()=>{ ensureAtLeastOneNight(true); recalc(); });
    elCheckOut.addEventListener('change', ()=>{ ensureAtLeastOneNight(false); recalc(); });
    elBtnToday.addEventListener('click', ()=>{
      const today=new Date(), tom=new Date(); tom.setDate(today.getDate()+1);
      elCheckIn.value=fmtDate(today); elCheckOut.value=fmtDate(tom); recalc();
    });
    document.getElementById('minusCats').addEventListener('click', ()=>{ cats=Math.max(1,cats-1); clampCats(); recalc(); });
    document.getElementById('plusCats').addEventListener('click',  ()=>{ cats+=1; clampCats(); recalc(); });

    renderRooms(); clampCats(); recalc();

    /* ------------------ Page 2：月曆 ------------------ */
    const tabCalc = document.getElementById('tabCalc');
    const tabCalendar = document.getElementById('tabCalendar');
    const pageCalc = document.getElementById('pageCalc');
    const pageCalendar = document.getElementById('pageCalendar');

    tabCalc.addEventListener('click', ()=>{ tabCalc.classList.add('active'); tabCalendar.classList.remove('active'); pageCalc.style.display='block'; pageCalendar.style.display='none'; });
    tabCalendar.addEventListener('click', ()=>{ tabCalendar.classList.add('active'); tabCalc.classList.remove('active'); pageCalendar.style.display='block'; pageCalc.style.display='none'; drawCalendar(); });

    const monthTitle = document.getElementById('monthTitle');
    const calTableBody = document.querySelector('#calTable tbody');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const monthStats = document.getElementById('monthStats');

    let curY, curM;
    const TOTAL_ROOMS = 8;

    function ymKey(y,m){ return `${y}-${String(m+1).padStart(2,'0')}`; }
    function dKey(y,m,day){ return `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`; }
    function loadMonthData(y,m){ const raw=localStorage.getItem('inv_'+ymKey(y,m)); return raw?JSON.parse(raw):{}; }
    function saveMonthData(y,m,data){ localStorage.setItem('inv_'+ymKey(y,m), JSON.stringify(data)); }

    function drawCalendar(){
      const today = new Date();
      if (curY==null){ curY=today.getFullYear(); curM=today.getMonth(); }
      const first = new Date(curY, curM, 1);
      const firstDay = first.getDay();
      const daysInMonth = new Date(curY, curM+1, 0).getDate();
      const data = loadMonthData(curY,curM);

      monthTitle.textContent = `${curY} 年 ${String(curM+1).padStart(2,'0')} 月`;
      calTableBody.innerHTML = '';

      let tr = document.createElement('tr');
      for (let i=0;i<firstDay;i++) tr.appendChild(document.createElement('td'));

      for (let d=1; d<=daysInMonth; d++){
        if (tr.children.length===7){ calTableBody.appendChild(tr); tr=document.createElement('tr'); }
        const td = document.createElement('td');
        const key = dKey(curY,curM,d);
        const booked = data[key] || 0;
        const left = Math.max(0, TOTAL_ROOMS - booked);

        td.innerHTML = `
          <div><strong>${d}</strong></div>
          <div class="${left===0?'soldout':'ok'}">${left===0?'滿房':'剩 '+left}</div>
          <div class="left">已訂 ${booked}</div>
        `;
        td.style.cursor='pointer';
        td.addEventListener('click', ()=>{
          const cur = data[key] || 0;
          const next = (cur+1) > TOTAL_ROOMS ? 0 : (cur+1);
          data[key] = next;
          saveMonthData(curY,curM,data);
          drawCalendar();
        });
        tr.appendChild(td);
      }
      if (tr.children.length>0){ while(tr.children.length<7){ tr.appendChild(document.createElement('td')); } calTableBody.appendChild(tr); }

      const sold = Object.values(loadMonthData(curY,curM)).reduce((a,b)=>a+b,0);
      monthStats.innerHTML = `
        <div class="grid">
          <div><div class="label">本月總房數（天×8）</div><div>${daysInMonth * TOTAL_ROOMS}</div></div>
          <div><div class="label">本月已售總數</div><div>${sold}</div></div>
          <div><div class="label">本月剩餘總數</div><div>${daysInMonth * TOTAL_ROOMS - sold}</div></div>
        </div>
      `;
    }
    document.getElementById('prevMonth').addEventListener('click', ()=>{ if (curM===0){curM=11;curY--} else curM--; drawCalendar(); });
    document.getElementById('nextMonth').addEventListener('click', ()=>{ if (curM===11){curM=0;curY++} else curM++; drawCalendar(); });
  </script>
</body>
</html>
